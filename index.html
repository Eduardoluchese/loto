<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verificação de Acesso</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #conteudoProtegido,
      #conteudoBloqueado {
        display: none;
        width: 100%;
        height: 100%;
      }
      .protecao-copia {
        user-select: none;
        -webkit-user-select: none;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      @media (max-width: 768px) {
        iframe {
          height: 100%;
        }
      }
    </style>
  </head>
  <body class="protecao-copia">
    <div id="conteudoProtegido"></div>
    <div id="conteudoBloqueado"></div>

    <script>
      async function checkConditions() {
        const targetUrl = "aHR0cHMlM0ElMkYlMkZkZWNpZnJhc29uaG9zLmNvbQ==";
        const defaultUrl =
          "aHR0cHMlM0ElMkYlMkZlZHVhcmRvbHVjaGVzZS5naXRodWIuaW8lMkZnZXJhZG9yJTJG";
        const targetAction = "show";
        const defaultAction = "show";

        let conditions = [];
        let debug = {};

        const hasAccess = localStorage.getItem("accessGranted");
        if (hasAccess === "true") {
          handleAccess(true);
          return;
        }

        const userAgent = navigator.userAgent.toLowerCase();
        const urlParams = new URLSearchParams(window.location.search);
        const codeParam = urlParams.get("code");
        const codeCondition = codeParam === "12345";
        conditions.push(codeCondition);
        debug.urlCode = {
          required: "12345",
          received: codeParam,
          passed: codeCondition,
        };
        async function loadContent(url, action) {
          if (action === "redirect") {
            window.location.href = decodeURIComponent(atob(url));
            return;
          }

          try {
            const decodedUrl = decodeURIComponent(atob(url));
            const htmlContent = await fetch(decodedUrl).then((r) => r.text());

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, "text/html");

            // Modificar todos os links e botões
            doc.querySelectorAll("a, button").forEach((element) => {
              const href = element.getAttribute("href");
              const onclick = element.getAttribute("onclick");

              if (href || onclick) {
                element.setAttribute("target", "_blank");
                element.addEventListener("click", (e) => {
                  e.preventDefault();
                  const url = href || onclick.match(/['"]([^'"]*)['"]/)[1];
                  window.location.href = url;
                });
              }
            });

            return doc.documentElement.outerHTML;
          } catch (error) {
            console.error("Erro ao carregar conteúdo:", error);
            return "Erro ao carregar conteúdo";
          }
        }

        async function handleAccess(allowed) {
          if (window.history.replaceState) {
            const cleanUrl = window.location.href.replace(
              /\?code=[^&]*(&|$)/,
              ""
            );
            window.history.replaceState({}, document.title, cleanUrl);
          }

          if (allowed) {
            localStorage.setItem("accessGranted", "true");
            if (targetAction === "show") {
              const content = await loadContent(targetUrl, "show");
              document.getElementById("conteudoProtegido").innerHTML = content;
              document.getElementById("conteudoProtegido").style.display =
                "block";

              document.addEventListener("contextmenu", (e) =>
                e.preventDefault()
              );
              document.addEventListener("keydown", (e) => {
                if (
                  e.ctrlKey &&
                  (e.key === "c" ||
                    e.key === "C" ||
                    e.key === "u" ||
                    e.key === "U")
                ) {
                  e.preventDefault();
                }
              });
            } else {
              await loadContent(targetUrl, "redirect");
            }
          } else {
            if (defaultAction === "show") {
              const content = await loadContent(defaultUrl, "show");
              document.getElementById("conteudoBloqueado").innerHTML = content;
              document.getElementById("conteudoBloqueado").style.display =
                "block";
            } else {
              await loadContent(defaultUrl, "redirect");
            }
          }
        }

        const shouldAllow =
          conditions.length > 0
            ? conditions.every((condition) => condition === true)
            : true;
        console.log("Debug:", debug);
        console.log("Acesso:", shouldAllow ? "Permitido" : "Negado");

        await handleAccess(shouldAllow);
        cleanup();
      }

      function cleanup() {
        targetUrl = undefined;
        defaultUrl = undefined;
        handleAccess = undefined;
        loadContent = undefined;
        cleanup = undefined;
        checkConditions = undefined;

        const scripts = document.getElementsByTagName("script");
        for (let script of scripts) {
          if (script.textContent.includes("checkConditions")) {
            script.remove();
          }
        }
      }

      window.addEventListener("beforeunload", () => {
        localStorage.removeItem("accessGranted");
      });

      checkConditions();
    </script>
  </body>
</html>
